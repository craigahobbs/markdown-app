# Licensed under the MIT License
# https://github.com/craigahobbs/markdown-up/blob/main/LICENSE

include '../unittest.mds'


# Helper to begin mocking the unittest global state
function testUnittestMockBegin():
    result = arrayNew(systemGlobalGet('unittestTests'), systemGlobalGet('unittestWarnings'), systemGlobalGet('unittestTestName'))
    systemGlobalSet('unittestTests', objectNew())
    systemGlobalSet('unittestWarnings', arrayNew())
    systemGlobalSet('unittestTestName', null)
    return result
endfunction


# Helper to end mocking the unittest global state
function testUnittestMockEnd(beginResult):
    result = arrayNew(systemGlobalGet('unittestTests'), systemGlobalGet('unittestWarnings'))
    systemGlobalSet('unittestTests', arrayGet(beginResult, 0))
    systemGlobalSet('unittestWarnings', arrayGet(beginResult, 1))
    systemGlobalSet('unittestTestName', arrayGet(beginResult, 2))
    return result
endfunction


# Helper unittest functions
function testUnittest_testPass():
    unittestEqual(1 + 1, 2)
    unittestDeepEqual(arrayPush(arrayNew(1), 2), arrayNew(1, 2))
endfunction

function testUnittest_testFail():
    unittestEqual(1 + 1, 3)
    unittestDeepEqual(arrayPush(arrayNew(1), 2), arrayNew(1, 2, 3))
endfunction

async function testUnittest_testPassAsync():
    testUnittest_testPass()
endfunction

async function testUnittest_testFailAsync():
    testUnittest_testFail()
endfunction


function testUnittestRunTest():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTest('testUnittest_testPass')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 0)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 1 tests - 1 passed, 0 failed', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPass](#var.vTest='testUnittest_testPass') - OK" \
        ) \
    ))
endfunction
unittestRunTest('testUnittestRunTest')


function testUnittestRunTest_failure():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTest('testUnittest_testPass')
    unittestRunTest('testUnittest_testFail')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 2 tests - 1 passed, 1 failed', \
            '', \
            '## Failing Tests', \
            '', \
            "[testUnittest\\_testFail](#var.vTest='testUnittest_testFail') - FAIL", \
            '', \
            '- ~~~', \
            '  2', \
            '  ~~~', \
            '  ', \
            '  !=', \
            '  ', \
            '  ~~~', \
            '  3', \
            '  ~~~', \
            '', \
            '- ~~~', \
            '  [1,2]', \
            '  ~~~', \
            '  ', \
            '  !=', \
            '  ', \
            '  ~~~', \
            '  [1,2,3]', \
            '  ~~~', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPass](#var.vTest='testUnittest_testPass') - OK" \
        ) \
    ))

endfunction
unittestRunTest('testUnittestRunTest_failure')


function testUnittestRunTest_multiple():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTest('testUnittest_testPass')
    unittestRunTest('testUnittest_testPass')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 1 tests - 1 passed, 0 failed', \
            '', \
            '## Warnings', \
            '', \
            '- Test \\"testUnittest\\_testPass\\" run multiple times', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPass](#var.vTest='testUnittest_testPass') - OK" \
        ) \
    ))
endfunction
unittestRunTest('testUnittestRunTest_multiple')


function testUnittestRunTest_unknown():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTest('testUnittest_testUnknown')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 0 tests - 0 passed, 0 failed', \
            '', \
            '## Warnings', \
            '', \
            '- Test \\"testUnittest\\_testUnknown\\" not found' \
        ) \
    ))
endfunction
unittestRunTest('testUnittestRunTest_unknown')


async function testUnittestRunTestAsync():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTestAsync('testUnittest_testPassAsync')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 0)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 1 tests - 1 passed, 0 failed', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPassAsync](#var.vTest='testUnittest_testPassAsync') - OK" \
        ) \
    ))
endfunction
unittestRunTestAsync('testUnittestRunTestAsync')


async function testUnittestRunTestAsync_failure():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTestAsync('testUnittest_testPassAsync')
    unittestRunTestAsync('testUnittest_testFailAsync')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 2 tests - 1 passed, 1 failed', \
            '', \
            '## Failing Tests', \
            '', \
            "[testUnittest\\_testFailAsync](#var.vTest='testUnittest_testFailAsync') - FAIL", \
            '', \
            '- ~~~', \
            '  2', \
            '  ~~~', \
            '  ', \
            '  !=', \
            '  ', \
            '  ~~~', \
            '  3', \
            '  ~~~', \
            '', \
            '- ~~~', \
            '  [1,2]', \
            '  ~~~', \
            '  ', \
            '  !=', \
            '  ', \
            '  ~~~', \
            '  [1,2,3]', \
            '  ~~~', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPassAsync](#var.vTest='testUnittest_testPassAsync') - OK" \
        ) \
    ))

endfunction
unittestRunTestAsync('testUnittestRunTestAsync_failure')


async function testUnittestRunTestAsync_multiple():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTestAsync('testUnittest_testPassAsync')
    unittestRunTestAsync('testUnittest_testPassAsync')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 1 tests - 1 passed, 0 failed', \
            '', \
            '## Warnings', \
            '', \
            '- Test \\"testUnittest\\_testPassAsync\\" run multiple times', \
            '', \
            '## Passing Tests', \
            '', \
            "[testUnittest\\_testPassAsync](#var.vTest='testUnittest_testPassAsync') - OK" \
        ) \
    ))
endfunction
unittestRunTestAsync('testUnittestRunTestAsync_multiple')


async function testUnittestRunTestAsync_unknown():
    # Setup mocks
    unittestMockBegin_markdownPrint()

    # Run unit tests and report
    mockBegin = testUnittestMockBegin()
    unittestRunTest('testUnittest_testUnknownAsync')
    result = unittestReport()
    testUnittestMockEnd(mockBegin)

    # Verify report result
    unittestEqual(result, 1)

    # Reset mocks
    unittestDeepEqual(unittestMockEnd(), objectNew( \
        'markdownPrint', arrayNew( \
            '', \
            'Ran 0 tests - 0 passed, 0 failed', \
            '', \
            '## Warnings', \
            '', \
            '- Test \\"testUnittest\\_testUnknownAsync\\" not found' \
        ) \
    ))
endfunction
unittestRunTestAsync('testUnittestRunTestAsync_unknown')
