# Licensed under the MIT License
# https://github.com/craigahobbs/markdown-up/blob/main/LICENSE


#
# The MarkdownUp launcher index application
#


async function markdownUpIndex()
    # Fetch the index files/directories/parent API
    index_url = 'markdown_up_index' + if(vPath != null, '?path=' + urlEncodeComponent(vPath), '')
    index = httpFetch(index_url)

    # Set the document title
    path = objectGet(index, 'path')
    title = 'MarkdownUp - ' + path
    setDocumentTitle(title)

    # Menu and title
    parent = objectGet(index, 'parent')
    markdownPrint( \
        if(vPath == null, 'Root', '[Root](#var=)') + ' |', \
        if(vPath == null, 'Parent', \
            '[Parent](' + if(parent == null, '#var=', "#var.vPath='" + urlEncodeComponent(parent) + "'") + ')') + ' |', \
        '[MarkdownUp](https://github.com/craigahobbs/markdown-up#readme)', \
        '', \
        '# ' + title \
    )

    # Render file links
    files = objectGet(index, 'files')
    if files != null:
        markdownPrint('', '## Files')
        for file in files:
            fileURL = if(vPath != null, vPath + '/', '') + file
            markdownPrint('', '[' + markdownEscape(file) + '](#url=' + urlEncodeComponent(fileURL) + '&var=)')
        endfor
    endif

    # Render directory links
    directories = objectGet(index, 'directories')
    if directories != null:
        markdownPrint('', '## Directories')
        for directory in directories:
            directoryURL = if(vPath != null, vPath + '/', '') + directory
            markdownPrint('', '[' + markdownEscape(directory) + "](#var.vPath='" + urlEncodeComponent(directoryURL) + "')")
        endfor
    endif

    # Empty path?
    if files == null && directories == null:
        markdownPrint('', 'No Markdown files or sub-directories found')
    endif
endfunction
